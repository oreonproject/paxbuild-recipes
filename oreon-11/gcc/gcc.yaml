name: gcc
version: "14.2.0"
description: "GNU Compiler Collection - C, C++, and other language compilers"
author: "GNU Project"
license: "GPL-3.0-or-later WITH GCC-exception-3.1"
homepage: "https://gcc.gnu.org/"
repository: "https://gcc.gnu.org/git/gcc.git"
source_url: "https://sourceware.org/pub/gcc/releases/gcc-14.2.0/gcc-14.2.0.tar.xz"
keywords: [gcc, compiler, c, c++, gnu]
categories: [development, system]

dependencies:
  build_dependencies:
    - {name: "gcc", version_constraint: ">=11", optional: false}
    - {name: "gcc-c++", version_constraint: ">=11", optional: false}
    - {name: "make", version_constraint: ">=4.3", optional: false}
    - {name: "gawk", version_constraint: ">=5.1", optional: false}
    - {name: "bison", version_constraint: ">=3.8", optional: false}
    - {name: "flex", version_constraint: ">=2.6", optional: false}
    - {name: "texinfo", version_constraint: ">=7.0", optional: false}
    - {name: "texinfo-tex", version_constraint: ">=7.0", optional: false}
    - {name: "gettext", version_constraint: ">=0.21", optional: false}
    - {name: "zlib-devel", version_constraint: ">=1.2", optional: false}
    - {name: "gmp-devel", version_constraint: ">=6.2", optional: false}
    - {name: "mpfr-devel", version_constraint: ">=4.2", optional: false}
    - {name: "libmpc-devel", version_constraint: ">=1.3", optional: false}
    - {name: "libzstd-devel", version_constraint: ">=1.5", optional: false}
    - {name: "libunwind-devel", version_constraint: ">=1.6", optional: false}
    - {name: "systemtap-sdt-devel", version_constraint: ">=1.3", optional: false}
    - {name: "elfutils-devel", version_constraint: ">=0.188", optional: false}
    - {name: "elfutils-libelf-devel", version_constraint: ">=0.188", optional: false}
    - {name: "binutils-devel", version_constraint: ">=2.43", optional: false}
    - {name: "binutils", version_constraint: ">=2.43", optional: false}
    - {name: "gdb", version_constraint: ">=14.2", optional: false}
    - {name: "gcc-gnat", version_constraint: ">=14.2", optional: false}
    - {name: "libgnat", version_constraint: ">=14.2", optional: false}
    - {name: "gcc-gdc", version_constraint: ">=14.2", optional: false}
    - {name: "libgphobos-static", version_constraint: ">=14.2", optional: false}
    - {name: "python3-devel", version_constraint: ">=3.11", optional: false}
    - {name: "python3", version_constraint: ">=3.11", optional: false}
    - {name: "python3-sphinx", version_constraint: ">=5.3", optional: false}
    - {name: "python-sphinx", version_constraint: ">=5.3", optional: false}
    - {name: "hostname", version_constraint: null, optional: false}
    - {name: "procps", version_constraint: null, optional: false}
    - {name: "doxygen", version_constraint: ">=1.8", optional: false}
    - {name: "graphviz", version_constraint: null, optional: false}
    - {name: "dblatex", version_constraint: null, optional: false}
    - {name: "texlive-collection-latex", version_constraint: null, optional: false}
    - {name: "docbook5-style-xsl", version_constraint: null, optional: false}
    - {name: "llvm", version_constraint: ">=15", optional: false}
    - {name: "lld", version_constraint: ">=15", optional: false}
    - {name: "annobin-plugin-gcc", version_constraint: ">=10.62", optional: false}
    - {name: "rpm-devel", version_constraint: null, optional: false}
    - {name: "glibc-devel", version_constraint: ">=2.38", optional: false}
    - {name: "glibc-static", version_constraint: ">=2.38", optional: false}
    - {name: "glibc", version_constraint: ">=2.38", optional: false}
    - {name: "tzdata", version_constraint: ">=2024a", optional: false}
  runtime_dependencies:
    - {name: "glibc", version_constraint: ">=2.30", optional: false}
    - {name: "binutils", version_constraint: ">=2.25", optional: false}
  optional_dependencies: []
  conflicts: []

build:
  build_system: Make
  build_commands:
    - |
      locate_gcc_src() {
        if [ -f configure ] && [ -d contrib ]; then
          pwd
          return 0
        fi
        find . -maxdepth 1 -type f -name 'gcc-*.tar.*' -print -quit | while read -r archive; do
          echo "Extracting ${archive##*/}..."
          case "$archive" in
            *.tar.xz) tar -xJf "$archive" ;;
            *.tar.gz) tar -xzf "$archive" ;;
            *.tar.bz2) tar -xjf "$archive" ;;
            *.tar) tar -xf "$archive" ;;
          esac
        done
        CANDIDATE=$(find . -maxdepth 1 -mindepth 1 -type d -name 'gcc-*' | head -1)
        if [ -n "$CANDIDATE" ] && [ -f "$CANDIDATE/configure" ]; then
          (cd "$CANDIDATE" && pwd)
          return 0
        fi
        return 1
      }
      GCC_DIR=$(locate_gcc_src) || {
        echo "Unable to locate extracted GCC sources" >&2
        exit 1
      }
      cd "$GCC_DIR"
      fetch_and_symlink() {
        local dest_name="$1"
        local archive="$2"
        shift 2
        local urls=("$@")
        if [ ! -f "$archive" ]; then
          echo "Fetching $archive..."
          for url in "${urls[@]}"; do
            if command -v curl >/dev/null 2>&1; then
              if curl -fL -o "$archive" "$url"; then
                break
              fi
            elif command -v wget >/dev/null 2>&1; then
              if wget -O "$archive" "$url"; then
                break
              fi
            fi
            rm -f "$archive"
          done
        fi
        if [ ! -f "$archive" ]; then
          echo "Failed to fetch $archive" >&2
          exit 1
        fi
        local extracted="${archive%.tar.*}"
        if [ ! -d "$extracted" ]; then
          case "$archive" in
            *.tar.xz) tar -xJf "$archive" ;;
            *.tar.gz) tar -xzf "$archive" ;;
            *.tar.bz2) tar -xjf "$archive" ;;
            *.tar) tar -xf "$archive" ;;
          esac
        fi
        rm -f "$dest_name"
        ln -sfn "$extracted" "$dest_name"
      }
      fetch_and_symlink gmp gmp-6.2.1.tar.bz2 \
        https://mirrors.kernel.org/gnu/gmp/gmp-6.2.1.tar.bz2 \
        https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.bz2
      fetch_and_symlink mpfr mpfr-4.1.0.tar.bz2 \
        https://mirrors.kernel.org/gnu/mpfr/mpfr-4.1.0.tar.bz2 \
        https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.bz2
      fetch_and_symlink mpc mpc-1.2.1.tar.gz \
        https://mirrors.kernel.org/gnu/mpc/mpc-1.2.1.tar.gz \
        https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz
      fetch_and_symlink isl isl-0.24.tar.bz2 \
        https://mirrors.kernel.org/gnu/gcc/infrastructure/isl-0.24.tar.bz2 \
        https://libisl.sourceforge.io/isl-0.24.tar.bz2
      fetch_and_symlink gettext gettext-0.22.tar.gz \
        https://mirrors.kernel.org/gnu/gettext/gettext-0.22.tar.gz \
        https://ftp.gnu.org/gnu/gettext/gettext-0.22.tar.gz
    - |
      locate_gcc_src() {
        if [ -f configure ] && [ -d contrib ]; then
          pwd
          return 0
        fi
        CANDIDATE=$(find . -maxdepth 1 -mindepth 1 -type d -name 'gcc-*' | head -1)
        if [ -n "$CANDIDATE" ] && [ -f "$CANDIDATE/configure" ]; then
          (cd "$CANDIDATE" && pwd)
          return 0
        fi
        return 1
      }
      GCC_DIR=$(locate_gcc_src) || {
        echo "Unable to locate extracted GCC sources" >&2
        exit 1
      }
      mkdir -p "$GCC_DIR/build" && cd "$GCC_DIR/build" && "$GCC_DIR/configure" \
        --prefix=/usr \
        --enable-languages=c,c++,fortran,objc,obj-c++,ada,d \
        --disable-multilib \
        --enable-threads=posix \
        --enable-shared \
        --enable-__cxa_atexit \
        --with-system-zlib \
        --with-default-libstdcxx-abi=gcc4-compatible \
        --enable-libstdcxx-filesystem-ts \
        --enable-plugins \
        --with-linker-hash-style=gnu \
        --with-gmp="$GCC_DIR/gmp" \
        --with-mpfr="$GCC_DIR/mpfr" \
        --with-mpc="$GCC_DIR/mpc" \
        --with-isl="$GCC_DIR/isl"
    - |
      locate_gcc_src() {
        if [ -f configure ] && [ -d contrib ]; then
          pwd
          return 0
        fi
        CANDIDATE=$(find . -maxdepth 1 -mindepth 1 -type d -name 'gcc-*' | head -1)
        if [ -n "$CANDIDATE" ] && [ -f "$CANDIDATE/configure" ]; then
          (cd "$CANDIDATE" && pwd)
          return 0
        fi
        return 1
      }
      GCC_DIR=$(locate_gcc_src) || {
        echo "Unable to locate extracted GCC sources" >&2
        exit 1
      }
      cd "$GCC_DIR/build" && make -j$(nproc)
  build_dependencies:
    - "gcc"
    - "gcc-c++"
    - "make"
    - "gawk"
    - "bison"
    - "flex"
    - "texinfo"
    - "texinfo-tex"
    - "gettext"
    - "zlib-devel"
    - "gmp-devel"
    - "mpfr-devel"
    - "libmpc-devel"
    - "libzstd-devel"
    - "libunwind-devel"
    - "systemtap-sdt-devel"
    - "elfutils-devel"
    - "elfutils-libelf-devel"
    - "binutils-devel"
    - "binutils"
    - "gdb"
    - "gcc-gnat"
    - "libgnat"
    - "gcc-gdc"
    - "libgphobos-static"
    - "python3-devel"
    - "python3"
    - "python3-sphinx"
    - "python-sphinx"
    - "hostname"
    - "procps"
    - "doxygen"
    - "graphviz"
    - "dblatex"
    - "texlive-collection-latex"
    - "docbook5-style-xsl"
    - "llvm"
    - "lld"
    - "annobin-plugin-gcc"
    - "rpm-devel"
    - "glibc-devel"
    - "glibc-static"
    - "glibc"
    - "tzdata"
  build_flags: []
  environment:
    CFLAGS: "-O2"
    CXXFLAGS: "-O2"
  working_directory: null
  target_architectures: [X86_64v1, X86_64v3, Aarch64]
  cross_compiler_prefix: null
  target_sysroot: null

install:
  install_method: RunCommands
  install_commands:
    - |
      locate_gcc_src() {
        if [ -f configure ] && [ -d contrib ]; then
          pwd
          return 0
        fi
        CANDIDATE=$(find . -maxdepth 1 -mindepth 1 -type d -name 'gcc-*' | head -1)
        if [ -n "$CANDIDATE" ] && [ -f "$CANDIDATE/configure" ]; then
          (cd "$CANDIDATE" && pwd)
          return 0
        fi
        return 1
      }
      GCC_DIR=$(locate_gcc_src) || {
        echo "Unable to locate extracted GCC sources during install" >&2
        exit 1
      }
      cd "$GCC_DIR/build" && make install DESTDIR=$DESTDIR
    - "mkdir -p $DESTDIR/usr/lib/gcc"
    - "ldconfig -r $DESTDIR || true"
  install_directories: ["/usr/bin", "/usr/lib", "/usr/lib64", "/usr/include", "/usr/share"]
  install_files: []
  post_install_commands:
    - "echo 'GCC installed successfully'"
    - "echo 'Creating gcc symlinks...'"

files:
  include_patterns: ["**/*.c", "**/*.h", "**/*.cpp", "configure"]
  exclude_patterns: ["**/*.o", "build/**/*.o", "**/tests/**"]
  binary_files:
    - "usr/bin/gcc"
    - "usr/bin/g++"
    - "usr/bin/cpp"
    - "usr/lib/libgcc_s.so*"
    - "usr/lib64/libgcc_s.so*"
    - "usr/lib/libstdc++.so*"
    - "usr/lib64/libstdc++.so*"
  config_files: []
  documentation_files: []
  license_files: ["COPYING", "COPYING3", "COPYING.LIB", "COPYING.RUNTIME"]

scripts:
  pre_install: "echo 'Installing GCC (GNU Compiler Collection)...'"
  post_install: |
    echo "GCC installed successfully"
    echo "C and C++ compilers are now available"
  pre_uninstall: null
  post_uninstall: null
  pre_upgrade: null
  post_upgrade: null

metadata:
  maintainer: "Oreon Project Team <packaging@oreonproject.org>"
  section: "devel"
  priority: "optional"
  provides: ["gcc", "g++", "cpp", "libgcc", "libgcc_s", "libstdc++"]
  conflicts: []

